variables:
  GOBO: '$CI_PROJECT_DIR'

#
# Templates
#

.windows_before_script: &windows_before_script
  - Write-Host ""

.linux_before_script: &linux_before_script
  - cat /etc/*-release
  - arch
  - gcc --version

.windows_install_ge: &windows_install_ge
  - '& "$env:GOBO\.gitlab\do_it.bat" gec --version'

.linux_install_ge: &linux_install_ge
  - export PATH=$PATH:$GOBO/bin
  - gec --version

.linux_install_ise: &linux_install_ise
  - source $GOBO/.gitlab/install_ise.sh

#
# Build Gobo tools.
#

build_ge:
  stage: build_ge
  dependencies: []
  script:
    - Write-Host "Just to define the 'build_ge' stage name"
  rules:
    - when: never

linux_build_ge:
  stage: build_ge
  tags:
    - linux
  dependencies: []
  script:
    - pwsh -f "$env:GITHUB_WORKSPACE/.cicd/build_ge.ps1" gitlab
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_MERGE_REQUEST_ID
      when: never
    - if: $GOBO_CUSTOM_PIPELINE == null || $GOBO_CUSTOM_PIPELINE == "test_ise"
      when: on_success
  artifacts:
    when: always
    expire_in: 3 hours
    paths:
      - $GOBO/bin/
      - $GOBO/tool/gec/config/c/default.cfg

windows_build_ge:
  stage: build_ge
  tags:
    - shared-windows
    - windows
    - windows-1809
  dependencies: []
  script:
    - . "$env:GITHUB_WORKSPACE/.cicd/build_ge.ps1" gitlab
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_MERGE_REQUEST_ID
      when: never
    - if: $GOBO_CUSTOM_PIPELINE == null
      when: on_success
  artifacts:
    when: always
    expire_in: 3 hours
    paths:
      - $GOBO/bin/
      - $GOBO/tool/gec/config/c/default.cfg

#
# Running tests with Gobo Eiffel.
#

test_ge:
  stage: test_ge
  dependencies: []
  script:
    - Write-Host "Just to define the 'test_ge' stage name"
  rules:
    - when: never

library_windows_test_ge:
  stage: test_ge
  tags:
    - shared-windows
    - windows
    - windows-1809
  dependencies:
    - windows_build_ge
  before_script:
    - *windows_before_script
    - *windows_install_ge
  script:
    - cd "$env:GOBO\library"
    # The tests in `$GOBO\library\lexical` are failing in GitLab when using `geant test_ge`.
    - '& "$env:GOBO\.gitlab\do_it.bat" geant test_debug_ge'
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_MERGE_REQUEST_ID
      when: never
    - if: $GOBO_CUSTOM_PIPELINE == null
      when: on_success

# We have `tool_no_gec_windows_test_ge` and `tool_gec_windows_test_ge`,
# instead of just `tool_windows_test_ge`, because it takes more than
# 1 hour to run this job and the job timeout on GitLab runners for Windows 
# is set to 1 hour (even though it is set to 2 hours for the project).

tool_no_gec_windows_test_ge:
  stage: test_ge
  tags:
    - shared-windows
    - windows
    - windows-1809
  dependencies:
    - windows_build_ge
  before_script:
    - *windows_before_script
    - *windows_install_ge
  script:
    - Remove-Item "$env:GOBO\tool\gec\test" -Force -Recurse
    - cd "$env:GOBO\tool"
    - '& "$env:GOBO\.gitlab\do_it.bat" geant test_ge'
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_MERGE_REQUEST_ID
      when: never
    - if: $GOBO_CUSTOM_PIPELINE == null
      when: on_success

tool_gec_windows_test_ge:
  stage: test_ge
  tags:
    - shared-windows
    - windows
    - windows-1809
  dependencies:
    - windows_build_ge
  before_script:
    - *windows_before_script
    - *windows_install_ge
  script:
    - cd "$env:GOBO\tool\gec"
    - '& "$env:GOBO\.gitlab\do_it.bat" geant test_ge'
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_MERGE_REQUEST_ID
      when: never
    - if: $GOBO_CUSTOM_PIPELINE == null
      when: on_success

library_linux_test_ge:
  stage: test_ge
  tags:
    - linux
  dependencies:
    - linux_build_ge
  before_script:
    - *linux_before_script
    - *linux_install_ge
  script:
    - cd $GOBO/library
    - geant test_ge
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_MERGE_REQUEST_ID
      when: never
    - if: $GOBO_CUSTOM_PIPELINE == null
      when: on_success

tool_linux_test_ge:
  stage: test_ge
  tags:
    - linux
  dependencies:
    - linux_build_ge
  before_script:
    - *linux_before_script
    - *linux_install_ge
  script:
    - cd $GOBO/tool
    - geant test_ge
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_MERGE_REQUEST_ID
      when: never
    - if: $GOBO_CUSTOM_PIPELINE == null
      when: on_success

#
# Running tests with ISE Eiffel.
#

test_ise:
  stage: test_ise
  dependencies: []
  script:
    - Write-Host "Just to define the 'test_ise' stage name"
  rules:
    - when: never

library_linux_test_ise:
  stage: test_ise
  tags:
    - linux
  dependencies:
    - linux_build_ge
  before_script:
    - *linux_before_script
    - *linux_install_ge
    - *linux_install_ise
  script:
    - cd $GOBO/library
    - geant test_debug_ise
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_MERGE_REQUEST_ID
      when: never
    - if: $GOBO_CUSTOM_PIPELINE == "test_ise"
      when: on_success
  timeout: 3 hours

tool_linux_test_ise:
  stage: test_ise
  tags:
    - linux
  dependencies:
    - linux_build_ge
  before_script:
    - *linux_before_script
    - *linux_install_ge
    - *linux_install_ise
  script:
    - cd $GOBO/tool
    - geant test_debug_ise
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_MERGE_REQUEST_ID
      when: never
    - if: $GOBO_CUSTOM_PIPELINE == "test_ise"
      when: on_success
  timeout: 3 hours

#
# Stages.
#

stages:
  - build_ge
  - test_ge
  - test_ise
